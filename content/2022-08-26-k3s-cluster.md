+++
title = "Setting up a k3s cluster with Raspberry Pi"
date = 2022-03-20
+++

Here we go

<!-- more -->

## Why Raspberry pi?


## Why k3s?

## What I did

Following Alex Ellis' blog

Bought 3 Raspberry Pi kits from Canakit
TODO Get racking gear e.g. http://my.bitscope.com/store/checkout/ or UCTronics

Networking: Isolated vLAN on Ubiquiti gear

OS Decision: Ubuntu Server vs U Core vs Raspbian Lite
Ubuntu Core because everything uses Snap, designed to be easy to keep up to date
Also armhf (32) vs arm64

Config management: Ansible Terraform (lol Puppet)

Orchestrator Decision: k3s microk3s minikube Nomad???
microk3s because I can install it as a Snap

Core Services/Applications: arkade Helm kustomize

Deployment: ArgoCD

Use case: Discord bot, Grafana LGTM Monitoring stack, Cool k8s demos, Home Assistant, OpenFaaS learning, Private cloud (ownCloud?), Fediverse

Encountered issue with Ubuntu Core 22 where the ELFs provided were not compatible with the Raspberry Pi 1.5
Raspbian Lite worked fine (Debian 11, Linux 5.15)

Do setup on bwolf1 (set hostname, configure static IP)

Remember to setup cgroup_memory=1 cgroup_enable=memory in /boot/cmdline.txt
```
❯ k3sup install --ip 10.0.80.20 --user bh

~ [☁️  ]
❯ k get node -o wide
NAME     STATUS   ROLES                  AGE   VERSION        INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION   CONTAINER-RUNTIME
bwolf1   Ready    control-plane,master   46s   v1.24.4+k3s1   10.0.80.20    <none>        Debian GNU/Linux 11 (bullseye)   5.15.32-v8+      containerd://1.6.6-k3s1
```

tested it out by adding a nginx deployment, it worked!

Using k3sup to create the first server, then joining the other two
```
export CH=stable

echo Installing Server 1
k3sup install --user bh --ip 10.0.80.20 \
  --k3s-channel $CH \
  --cluster

echo Installing Server 2
k3sup join --user bh --ip 10.0.80.21 --server-ip 10.0.80.20 \
  --k3s-channel $CH \
  --server

echo Installing Server 3
k3sup join --user pi --ip 10.0.80.22 --server-ip 10.0.80.20 \
  --k3s-channel $CH \
  --server
```

And now I have three cluster servers running the full k3s control plane in HA
```
~ [☁️  ]
❯ k get nodes
NAME     STATUS   ROLES                       AGE   VERSION
bwolf1   Ready    control-plane,etcd,master   13m   v1.24.4+k3s1
bwolf2   Ready    control-plane,etcd,master   11m   v1.24.4+k3s1
bwolf3   Ready    control-plane,etcd,master   9s    v1.24.4+k3s1
```

